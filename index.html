<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>The Booha Adventure ‚Äî Year One</title>
<link rel="icon" type="image/png" href="BoohaYellow.png">

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet" />

<style>
:root{--zoom:1;--tx:0px;--ty:0px;}
*{box-sizing:border-box;margin:0;padding:0}

html,body{
  width:100%;
  height:100%;
  overflow-x:hidden;
  overflow-y:auto;
  background:#0b1c11;
  font-family:system-ui,"Noto Sans JP",sans-serif;
}

/* Viewport + world */
.viewport{
  position:relative;
  width:100vw;
  min-height:100vh;
  overflow:visible;
}

.world{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(calc(-50% + var(--tx)),calc(-50% + var(--ty))) scale(var(--zoom));
  transform-origin:center;
  transition:transform .65s cubic-bezier(.22,.65,.2,1);
}

/* Maze locked to 1024√ó1536 (2:3) image */
#maze{
  position:relative;
  width:min(100vw, calc(100vh * (2/3)));
  aspect-ratio:2 / 3;
  background:url('assets/maze.png') center / 100% 100% no-repeat;
  margin:0 auto;
  touch-action:pan-y; /* allow vertical scroll on mobile */
}

/* Boo-riculum Tree (inside the maze) */
#booTree{
  position:absolute;
  left:83.84%;
  top:8.40%;
  transform:translate(-50%, -50%);
  width:18%;              /* not gigantic */
  aspect-ratio:1 / 1;
  opacity:0;
  cursor:pointer;
  z-index:15;
  transition:
    opacity 1.8s ease-out,
    filter 2s ease-out;
  /* subtle base glow */
  filter:drop-shadow(0 0 5px #00ffaa40);
}

#booTree.glow {
  opacity: 1;
  filter: drop-shadow(0 0 8px #00ffcc88);
  animation: treeFlicker 4s infinite;
}


/* Tetris Tree (inside the maze) */
#tetrisTree{
  position:absolute;
  left:32.13%;
  top:37.45%;
  transform:translate(-50%, -50%);
  width:12%;              /* smaller than Boo-riculum tree */
  aspect-ratio:1 / 1;
  opacity:0;
  cursor:pointer;
  z-index:14;
  transition:
    opacity 1.8s ease-out,
    filter 2s ease-out;
  /* subtle purple base glow */
  filter:drop-shadow(0 0 5px #b388ff40);
}

#tetrisTree.glow{
  opacity:1;
  filter:
    drop-shadow(0 0 8px #c084ff88)
    drop-shadow(0 0 16px #8b5cf644);
  animation: tetrisTreeFlicker 4s infinite;
}

/* Slightly different flicker so it feels related but unique */
@keyframes tetrisTreeFlicker{
  0%,100% { filter:
    drop-shadow(0 0 8px #c084ff88)
    drop-shadow(0 0 16px #8b5cf644);
  }
  50% { filter:
    drop-shadow(0 0 12px #d8b4feaa)
    drop-shadow(0 0 22px #a855f766);
  }
}

  

/* --------------------------------------
   MAP OBJECTS (Trees / Review Decks)
-------------------------------------- */
.mapObj{
  position:absolute;
  transform:translate(-50%,-50%);
  cursor:pointer;
  z-index:15;
  filter:drop-shadow(0 0 5px #00ffaa40);
}

.mapObj.glow{
  animation:treeFlicker 4s infinite;
  filter:drop-shadow(0 0 10px #00ffccaa);
}

/* FX layer for explosions / sparkles (iOS safe) */
#fxLayer{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:9999;
  overflow:visible;
  contain:layout paint;
}

/* Booha */
#booha{
  position:absolute;
  width:68px;
  height:68px;
  transform:translate(-50%,-50%) scale(1);
  z-index:12;
  pointer-events:none;
  opacity:0;
  filter:drop-shadow(0 0 10px #ffe17a) drop-shadow(0 4px 18px #000a);
}

@keyframes bob{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
}

.bobbing{animation:bob 3.6s ease-in-out infinite}

@keyframes glowPulse{
  0%{filter:drop-shadow(0 0 2px #fff6) drop-shadow(0 0 6px #ffd86d);}
  50%{filter:drop-shadow(0 0 14px #fff) drop-shadow(0 0 28px #ffd86d);}
  100%{filter:drop-shadow(0 0 10px #ffe17a) drop-shadow(0 4px 18px #000a);}
}

/* Poof smoke */
.smoke{
  position:absolute;
  width:160px;
  height:160px;
  left:0;
  top:0;
  transform:translate(-50%,-50%) scale(.5);
  pointer-events:none;
  z-index:10;
  background:radial-gradient(circle at 50% 50%,rgba(255,255,255,.9)0%,rgba(255,255,255,.5)30%,rgba(255,255,255,0)70%);
  animation:poof 1.2s ease-out forwards;
}

@keyframes poof{
  0%{opacity:1;transform:scale(.5);}
  60%{opacity:.6;transform:scale(2);}
  100%{opacity:0;transform:scale(3);}
}

/* Gold glitter trail */
.spark{
  position:absolute;
  width:4.4px;
  height:4.4px;
  border-radius:50%;
  pointer-events:none;
  background:radial-gradient(circle at 40% 40%,#fff,#ffd86d 60%,transparent 80%);
  box-shadow:0 0 6px #fff6cc,0 0 12px #ffd86d,0 0 20px #ffec9c;
  opacity:.97;
  animation:spark 1s ease-out forwards;
}

@keyframes spark{
  0%{transform:translate(0,0) scale(1);opacity:1}
  50%{opacity:.9}
  100%{transform:translate(0,12px) scale(.7);opacity:0}
}

/* Fairy glitter for big explosion */
.fairy{
  position:absolute;
  width:6px;
  height:6px;
  border-radius:50%;
  pointer-events:none;
  background:radial-gradient(circle,#fff 0%,currentColor 60%,transparent 80%);
  box-shadow:0 0 10px currentColor,0 0 26px currentColor,0 0 46px currentColor;
  opacity:.9;
  animation:drift var(--dur,2600ms) cubic-bezier(.2,.7,.1,1) forwards,
             twinkle .8s infinite alternate;
  z-index:20;
}

@keyframes drift{
  0%{transform:translate(-50%,-50%) scale(.9)}
  100%{transform:translate(calc(-50% + var(--dx)),calc(-50% + var(--dy))) scale(1.15);opacity:0}
}

@keyframes twinkle{
  0%{filter:brightness(1)}
  100%{filter:brightness(1.8)}
}

/* Maze shake */
@keyframes mazeShake{
  0%,100%{transform:translate(0,0);}
  25%{transform:translate(-2px,1px);}
  50%{transform:translate(2px,-1px);}
  75%{transform:translate(-1px,-2px);}
}

@keyframes treeFlicker {
  0%   { filter: drop-shadow(0 0 6px #00ffcc40); }
  8%   { filter: drop-shadow(0 0 10px #00ffcc90); }
  15%  { filter: drop-shadow(0 0 7px #00ffcc50); }
  22%  { filter: drop-shadow(0 0 12px #00ffeecc); }
  32%  { filter: drop-shadow(0 0 8px #00ffcc60); }
  45%  { filter: drop-shadow(0 0 14px #00ffeeee); }
  58%  { filter: drop-shadow(0 0 7px #00ffcc40); }
  72%  { filter: drop-shadow(0 0 11px #00ffeecc); }
  90%  { filter: drop-shadow(0 0 9px #00ffcc70); }
  100% { filter: drop-shadow(0 0 6px #00ffcc40); }
}

.viewport.shake{
  animation:mazeShake 0.35s ease-out;
}

/* Checkpoints */
.stop{
  position:absolute;
  width:18px;
  height:18px;
  border-radius:50%;
  transform:translate(-50%,-50%);
  opacity:0;
  pointer-events:none;
  z-index:11;
}

.stop.hidden{opacity:0;transform:scale(.6)}
.stop.active{
  opacity:1;
  pointer-events:auto;
  animation:pulse 2s ease-in-out infinite;
}
.stop.old{opacity:.8;pointer-events:auto;}

@keyframes pulse{
  0%,100%{filter:brightness(1)}
  50%{filter:brightness(1.4)}
}

/* Modal window */
.modal{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:#0008;
  z-index:120;
}

.modal.show{display:flex}

/* ‚úÖ FIXED: glow2 default + breathe includes glow2 */
.card{
  --glow:#9ad;
  --glow2:#ffd86d; /* secondary default so var is always defined */
  position:relative;
  width:min(760px,92vw);
  background:#0f1836;
  border:1px solid #ffffff26;
  border-radius:18px;
  padding:22px 24px 20px;
  color:#fff;
  text-align:center;
  transform:scale(.92);
  opacity:0;
  animation:pop .45s cubic-bezier(.2,.8,.2,1) forwards,
             breathe 3.2s ease-in-out .45s infinite;

  box-shadow:
    0 0 0 1px #ffffff10 inset,
    0 0 18px var(--glow),
    0 0 38px var(--glow),
    0 0 14px var(--glow2),
    0 0 30px var(--glow2);
}

@keyframes pop{
  to{transform:scale(1);opacity:1}
}

@keyframes breathe{
  0%,100%{
    box-shadow:
      0 0 0 1px #ffffff10 inset,
      0 0 18px var(--glow),
      0 0 38px var(--glow),
      0 0 14px var(--glow2),
      0 0 30px var(--glow2);
  }
  50%{
    box-shadow:
      0 0 0 1px #ffffff10 inset,
      0 0 28px var(--glow),
      0 0 58px var(--glow),
      0 0 20px var(--glow2),
      0 0 44px var(--glow2);
  }
}

.card .title-en{
  font-family:"Cinzel",serif;
  font-weight:900;
  font-size:clamp(22px,3.2vw,30px);
  text-shadow:0 0 14px var(--glow),0 0 28px var(--glow);
}

.card .title-jp{
  font-family:"Noto Sans JP",sans-serif;
  margin-top:6px;
  font-weight:700;
  opacity:.9;
}

.placeholders{
  display:flex;
  gap:16px;
  justify-content:center;
  margin-top:18px;
}

.box{
  width:180px;
  height:120px;
  border-radius:16px;
  background:linear-gradient(145deg,#0e1531,#121e45);
  border:1px solid #ffffff22;
  box-shadow:0 0 18px var(--glow), inset 0 0 0 1px #ffffff10;
  display:grid;
  place-items:center;
  font-family:"Cinzel",serif;
  font-weight:700;
}

/* Close (x) button */
.close-btn{
  position:absolute;
  top:8px;
  right:10px;
  border:none;
  background:transparent;
  color:#ffffffcc;
  font-size:18px;
  cursor:pointer;
  padding:4px 6px;
}
.close-btn:hover{color:#fff}

.card .hint{
  opacity:.8;
  margin-top:12px;
  font-size:.95rem;
}

/* Tools (Bryan) */
.tools{
  position:fixed;
  left:12px;
  bottom:12px;
  display:flex;
  gap:8px;
  z-index:200;
}

.btn{
  padding:10px 14px;
  font-weight:700;
  border-radius:12px;
  border:1px solid #ffffff26;
  background:#203a27;
  color:#e5edff;
  cursor:pointer;
  font-size:13px;
}
.btn:hover{background:#25452f}

.tools .btn{
  opacity:.45;
}
.tools .btn:hover{
  opacity:.9;
}

/* Start button */
.start-wrap{
  position:fixed;
  top:12px;
  left:12px;
  z-index:210;
}
.start-btn{
  padding:10px 18px;
}

/* Mobile tweaks */
@media (max-width:768px){
  .btn{
    padding:11px 16px;
    font-size:14px;
  }
  .tools{gap:6px;}
  #booha{width:60px;height:60px;}
  .card{padding:18px 16px 18px;}
}
</style>
</head>

<body>

<!-- üî• Token check script -->
<script>
  (async function() {
    const API_BASE = 'https://www.bryanharper.tokyo';
    const GATE_URL = 'https://www.bryanharper.tokyo/booha-gate';

    const MSG = {
      kicked: {
        en: "Someone just logged in using your name and PIN.",
        jp: "Âà•„ÅÆÁ´ØÊú´„Åß„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„Å®PIN„Åß„É≠„Ç∞„Ç§„É≥„Åï„Çå„Åæ„Åó„Åü„ÄÇ"
      },
      expired: {
        en: "Your session has expired. Please log in again.",
        jp: "„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆÊúâÂäπÊúüÈôê„ÅåÂàá„Çå„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éñ„Éº„Éè„Éº„Ç≤„Éº„Éà„Åã„Çâ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
      },
      invalid: {
        en: "Your session is invalid. Please log in again.",
        jp: "„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆÁ¢∫Ë™ç„Å´ÂïèÈ°å„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éñ„Éº„Éè„Éº„Ç≤„Éº„Éà„Åã„Çâ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
      },
      missing: {
        en: "No session found. Please log in through the Booha Gate.",
        jp: "„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Éñ„Éº„Éè„Éº„Ç≤„Éº„Éà„Åã„Çâ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
      },
      checkFailed: {
        en: "Session check failed. Please log in again.",
        jp: "„Çª„ÉÉ„Ç∑„Éß„É≥Á¢∫Ë™ç„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éñ„Éº„Éè„Éº„Ç≤„Éº„Éà„Åã„Çâ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
      },
      verifyProblem: {
        en: "There was a problem verifying your session. Please log in again.",
        jp: "„Çª„ÉÉ„Ç∑„Éß„É≥Á¢∫Ë™ç‰∏≠„Å´ÂïèÈ°å„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éñ„Éº„Éè„Éº„Ç≤„Éº„Éà„Åã„Çâ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
      }
    };

    function kickOut(kind, overrideEn) {
      const m = MSG[kind] || MSG.invalid;
      const en = overrideEn || m.en;
      alert(en + "\n\n" + m.jp);
      window.location.href = GATE_URL;
    }

    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');

    console.log('[Booha Adventure] token from URL:', token);

    if (!token) {
      kickOut('missing');
      return;
    }

    try {
      const url = API_BASE + '/_functions/verifyToken?token=' + encodeURIComponent(token);
      console.log('[Booha Adventure] calling:', url);

      const res = await fetch(url, {
        method: 'GET',
        headers: { 'Accept': 'application/json' }
      });

      if (!res.ok) {
        console.warn('[Booha Adventure] HTTP error status:', res.status);
        kickOut('checkFailed');
        return;
      }

      const data = await res.json();
      console.log('[Booha Adventure] verifyToken response:', data);

      if (!data.valid) {
        if (data.reason === "KICKED" || data.kicked === true || data.isActive === false) {
          kickOut('kicked');
          return;
        }

        if (data.expired) {
          kickOut('expired');
        } else {
          kickOut('invalid');
        }
        return;
      }

      console.log('‚úÖ Token valid ‚Äî welcome', data.firstName, data.lastName, 'role:', data.role);

      try {
        sessionStorage.setItem('boohaToken', token);
        console.log('[Booha Adventure] stored token in sessionStorage');
      } catch (e) {
        console.warn('[Booha Adventure] could not access sessionStorage:', e);
      }

      if (data.expiresAt) {
        const now = new Date();
        const expiresAt = new Date(data.expiresAt);
        const msRemaining = expiresAt.getTime() - now.getTime();

        console.log('[Booha Adventure] ms remaining until expiry:', msRemaining);

        if (msRemaining > 0) {
          setTimeout(() => {
            kickOut('expired');
          }, msRemaining);
        } else {
          kickOut('expired');
        }
      }

    } catch (err) {
      console.error('[Booha Adventure] token verification error:', err);
      kickOut('verifyProblem');
    }
  })();
</script>

<div class="start-wrap">
  <button class="btn start-btn" id="start">Start</button>
</div>

<div class="viewport" id="viewport">
  <div class="world" id="world">
    <div id="maze">
      <!-- Boo-riculum tree lives *inside* the maze -->
      <img id="booTree" src="assets/BooTree.png" alt="boo tree">

      <!-- Tetris Tree -->
      <img id="tetrisTree" src="assets/tetris-tree.png" alt="tetris tree">
    </div>
  </div>
</div>

<!-- Booha ghost -->
<img id="booha" src="assets/DeluxeBoo.png" alt="booha"/>

<!-- Bottom-left tools -->
<div class="tools">
  <button class="btn" id="bryanBtn">BRYAN</button>
  <button class="btn" id="exitBryanBtn" style="display:none;">EXIT BRYAN</button>
</div>

<!-- Modal window -->
<div class="modal" id="modal">
  <div class="card" id="card">
    <button class="close-btn" id="close-modal" aria-label="Close">‚úï</button>

    <div class="title-en" id="title-en">January ‚Äî Week 1</div>
    <div class="title-jp" id="title-jp">1Êúà„ÄÄÁ¨¨1ÈÄ±</div>

    <div class="placeholders">
      <!-- Study Deck -->
      <div class="box deck-btn" id="deck-study">
        <div class="deck-en">Study</div>
        <div class="deck-jp">„Åπ„Çì„Åç„Çá„ÅÜ</div>
      </div>

      <!-- Games Deck -->
      <div class="box deck-btn" id="deck-games">
        <div class="deck-en">Games</div>
        <div class="deck-jp">„Ç≤„Éº„É†</div>
      </div>
    </div>

    <div class="hint">„Ç≠„É©„Ç≠„É©„Åó„Å¶„ÅÑ„ÇãÈÄ±„Å´„ÇÇ„Å©„Å£„Å¶„Å≠ÔºÅ</div>
  </div>
</div>

<script>
// ----------------------------------------------------------
// BOOHA MAZE ‚Äî FULL SCRIPT WITH BRYAN MODE + TREE + COORDS
// ----------------------------------------------------------
/* ============================================================
   ‚úÖ WEEKLY EDIT ZONE (THIS IS THE ONLY PART YOU EDIT)
   ============================================================ */
const DECK_LINKS = [
  {
    // January ‚Äî Week 1 (index 0)
    study: "https://booha-adventure-studios.github.io/booha-study-decks/january/week1/",
    games: "https://booha-adventure-studios.github.io/january-booha-adventure-deck/week1/"
  },
  {
    // January ‚Äî Week 2 (index 1)
    study: "https://booha-adventure-studios.github.io/booha-study-decks/january/week2/",
    games: "https://booha-adventure-studios.github.io/january-booha-adventure-deck/week2/"
  },
  {
    // January ‚Äî Week 3 (index 2)
    study: "https://booha-adventure-studios.github.io/booha-study-decks/january/week3/",
    games: "https://booha-adventure-studios.github.io/january-booha-adventure-deck/week3/"
  },
  {
    // January ‚Äî Week 4 (index 3)
    study: "https://booha-adventure-studios.github.io/booha-study-decks/january/week4/",
    games: "https://booha-adventure-studios.github.io/january-booha-adventure-deck/week4/"
  },

  /* ==========================
     February
     ========================== */

  {
    // February ‚Äî Week 1 (index 4)
    study: "https://booha-adventure-studios.github.io/booha-study-decks/february/week1/",
    games: "https://booha-adventure-studios.github.io/booha-yearly-game-decks/february/week1/"
  },
  {
    // February ‚Äî Week 2 (index 5)
    study: "https://booha-adventure-studios.github.io/booha-study-decks/february/week2/",
    games: "https://booha-adventure-studios.github.io/booha-yearly-game-decks/february/week2/"
  },
  {
    // February ‚Äî Week 3 (index 6)
    study: "https://booha-adventure-studios.github.io/booha-study-decks/february/week3/",
    games: "https://booha-adventure-studios.github.io/booha-yearly-game-decks/february/week3/"
  },
  {
    // February ‚Äî Week 4 (index 7)
    study: "https://booha-adventure-studios.github.io/booha-study-decks/february/week4/",
    games: "https://booha-adventure-studios.github.io/booha-yearly-game-decks/february/week4/"
  }
];


const MAP_OBJECTS = [];
// add more objects here...

/* ============================================================
   üîí ENGINE ZONE (DO NOT EDIT)
   ============================================================ */

// remembers which checkpoint opened the popup (engine state ‚Äî do not edit)
let currentStopForModal = 0;

/* --------------------------------------
   Basic Constants
-------------------------------------- */
const MONTHS_EN=['January','February','March','April','May','June','July','August','September','October','November','December'];
const MONTHS_JP=['1Êúà','2Êúà','3Êúà','4Êúà','5Êúà','6Êúà','7Êúà','8Êúà','9Êúà','10Êúà','11Êúà','12Êúà'];

/* ‚úÖ Month theme colors (primary + accent)
   - Primary = structure / glow core
   - Accent  = sparkle / emotional contrast
*/
const MONTH_THEMES = [
  // ‚ùÑÔ∏è January ‚Äî Winter Magic
  { p:'#60A5FA', s:'#E9D5FF' }, // icy blue + lavender glow

  // üíó February ‚Äî Soft Heart / Winter Bloom
  { p:'#F472B6', s:'#0EA5E9' }, // pink warmth + winter sky

  // üå± March ‚Äî Early Spring Growth
  { p:'#22C55E', s:'#FDE047' }, // fresh green + sunlight

  // üå∏ April ‚Äî Sakura Garden
  { p:'#F9A8D4', s:'#86EFAC' }, // cherry blossom + soft green

  // üåº May ‚Äî Bright Energy / Confidence
  { p:'#F59E0B', s:'#A855F7' }, // amber + violet ambition

  // üåä June ‚Äî Ocean Adventure
  { p:'#0284C7', s:'#67E8F9' }, // deep sea + splash cyan

  // üî• July ‚Äî Summer Power
  { p:'#EF4444', s:'#FACC15' }, // hot red + sun yellow

  // üçç August ‚Äî Tropical Play
  { p:'#F97316', s:'#22C55E' }, // mango orange + jungle green

  // üçá September ‚Äî Focus & Calm
  { p:'#A855F7', s:'#06B6D4' }, // thoughtful purple + teal clarity

  // üéÉ October ‚Äî Halloween Booha
  { p:'#F97316', s:'#7C3AED' }, // pumpkin orange + spooky violet

  // üçÇ November ‚Äî Deep Autumn / Reflection
  { p:'#92400E', s:'#FCD34D' }, // harvest brown + warm gold

  // üéÑ December ‚Äî Frost & Gold Finale
  { p:'#38BDF8', s:'#EAB308' }  // frost blue + celebration gold
];


// 48 checkpoints
const POS = [
  {"x":29.43,"y":6.82},{"x":30.04,"y":55.60},{"x":72.05,"y":68.51},{"x":53.92,"y":13.34},
  {"x":23.47,"y":82.55},{"x":63.67,"y":32.74},{"x":32.22,"y":26.27},{"x":64.01,"y":82.87},
  {"x":55.77,"y":59.76},{"x":72.68,"y":23.97},{"x":44.46,"y":13.17},{"x":22.77,"y":63.78},
  {"x":45.77,"y":41.90},{"x":40.14,"y":73.89},{"x":37.55,"y":13.26},{"x":71.01,"y":59.21},
  {"x":42.32,"y":26.35},{"x":32.22,"y":82.54},{"x":56.73,"y":22.94},{"x":23.63,"y":89.92},
  {"x":63.51,"y":42.22},{"x":29.35,"y":9.92},{"x":41.73,"y":54.84},{"x":75.06,"y":80.00},
  {"x":20.89,"y":37.06},{"x":57.92,"y":94.52},{"x":69.35,"y":51.11},{"x":33.28,"y":89.65},
  {"x":72.20,"y":35.40},{"x":21.96,"y":74.21},{"x":55.67,"y":51.01},{"x":37.20,"y":26.51},
  {"x":55.98,"y":73.89},{"x":56.25,"y":31.98},{"x":55.77,"y":82.86},{"x":21.01,"y":45.56},
  {"x":64.36,"y":59.18},{"x":39.35,"y":64.05},{"x":71.49,"y":41.59},{"x":8.15,"y":86.51},
  {"x":48.97,"y":63.78},{"x":42.08,"y":94.37},{"x":82.80,"y":30.00},{"x":84.70,"y":74.29},
  {"x":43.39,"y":82.86},{"x":53.47,"y":41.96},{"x":29.35,"y":19.92},{"x":74.70,"y":94.92},
];

const maze=document.getElementById('maze');
const booha=document.getElementById('booha');
const modal=document.getElementById('modal');
const card=document.getElementById('card');
const titleEN=document.getElementById('title-en');
const titleJP=document.getElementById('title-jp');
const closeModalBtn=document.getElementById('close-modal');
const startBtn=document.getElementById('start');
const bryanBtn=document.getElementById('bryanBtn');
const exitBryanBtn=document.getElementById('exitBryanBtn');
const viewport=document.getElementById('viewport');
const booTree=document.getElementById('booTree');

/* --------------------------------------
   Audio
-------------------------------------- */
const bgm=new Audio('audio/sneaky.mp3'); bgm.loop=true;
const sfxCheckpoint=new Audio('audio/checkpoint.mp3');
let audioPrimed=false;

/* --------------------------------------
   State
-------------------------------------- */
let gameStarted=false;
let bryanMode=false;
let visitedBackup=null;   // for restoring after Bryan mode

// Local storage visited[]
const VISITED_KEY='boohaMazeVisitedStops';
let visited=new Array(POS.length).fill(false);

try{
  const stored=JSON.parse(localStorage.getItem(VISITED_KEY));
  if(Array.isArray(stored) && stored.length===POS.length) visited=stored;
}catch(e){}

function saveVisited(){
  try{ localStorage.setItem(VISITED_KEY,JSON.stringify(visited)); }
  catch(e){}
}

/* --------------------------------------
   Startup Audio
-------------------------------------- */
function primeAudio(){
  if(audioPrimed) return;
  audioPrimed=true;
  bgm.currentTime=0;
  bgm.play().catch(()=>{});
}

async function primeSfx(){
  try{
    const prevVol = sfxCheckpoint.volume;
    sfxCheckpoint.volume = 0;
    sfxCheckpoint.currentTime = 0;

    const p = sfxCheckpoint.play();
    if(p && p.then) await p;

    sfxCheckpoint.pause();
    sfxCheckpoint.currentTime = 0;
    sfxCheckpoint.volume = prevVol;
  }catch(e){
    console.warn('[primeSfx] could not prime checkpoint:', e);
  }
}

/* --------------------------------------
   Unlock window ‚Üí Sunday 2025-12-28
-------------------------------------- */
let todayIndex=0;
let WINDOW_START=0, WINDOW_END=0;

const UNLOCK_START = new Date(2025,11,28);

function getCurrentIndexFromDate(){
  const now=new Date();
  const todayMidnight=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const startMidnight=new Date(UNLOCK_START.getFullYear(),UNLOCK_START.getMonth(),UNLOCK_START.getDate());
  const diffMs=todayMidnight - startMidnight;
  if(diffMs<0) return -1;
  const diffDays=Math.floor(diffMs/86400000);
  const idx=Math.floor(diffDays/7);  // 0-based
  return Math.min(idx,POS.length-1);
}

function updateWindowFromCurrentIndex(idx){
  if(idx<0){ WINDOW_START=WINDOW_END=-1; return; }
  WINDOW_END=idx;
  WINDOW_START=Math.max(0,idx-3);
}

function getStopState(i){
  if(bryanMode) return "live";
  if(todayIndex<0) return "future";
  if(i<WINDOW_START) return "past";
  if(i<=WINDOW_END) return "live";
  return "future";
}

/* --------------------------------------
   Create Stops
-------------------------------------- */
const stops=[];
POS.forEach((p,i)=>{
  const el=document.createElement('div');
  el.className='stop hidden';
  el.style.left=p.x+'%';
  el.style.top=p.y+'%';

  el.addEventListener('click',(e)=>{
    e.stopPropagation();
    if(!el.classList.contains('active') && !el.classList.contains('old')) return;
    onStopClick(i);
  });

  maze.appendChild(el);
  stops.push({el,i});
});

/* --------------------------------------
   Color Helpers (Primary + Accent)
-------------------------------------- */
function monthPrimary(i){
  const m = Math.floor(i/4);
  return (MONTH_THEMES[m] && MONTH_THEMES[m].p) || '#38BDF8';
}
function monthAccent(i){
  const m = Math.floor(i/4);
  return (MONTH_THEMES[m] && MONTH_THEMES[m].s) || '#FACC15';
}

/* --------------------------------------
   Booha Position Helpers
-------------------------------------- */
function placeBoohaXY(x,y){
  booha.style.left=x+'px';
  booha.style.top=y+'px';
}

function startPosition(){
  const r=maze.getBoundingClientRect();
  return{
    x:r.left+window.scrollX+r.width*0.065,
    y:r.top+window.scrollY+r.height*0.085
  };
}

function stopPx(i,rect){
  const n=POS[i];
  return{
    x:rect.left+(n.x/100)*rect.width+window.scrollX,
    y:rect.top+(n.y/100)*rect.height+window.scrollY
  };
}

function easeInOutCubic(t){
  return t<0.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2;
}

/* --------------------------------------
   Spark Trail
-------------------------------------- */
function spawnSpark(x,y){
  const s=document.createElement('i');
  s.className='spark';
  s.style.left=x+'px';
  s.style.top=y+'px';
  document.body.appendChild(s);
  setTimeout(()=>s.remove(),1000);
}

/* --------------------------------------
   BIG Explosion (iOS tuned) ‚Äî two-tone
-------------------------------------- */
function fairyBurst(i){
  const p = monthPrimary(i);
  const s = monthAccent(i);

  // page coords (because stopPx adds scrollX/scrollY)
  const rect = maze.getBoundingClientRect();
  const { x: cxPage, y: cyPage } = stopPx(i, rect);

  // convert to viewport coords for a fixed layer
  const sx = window.pageXOffset || document.documentElement.scrollLeft || 0;
  const sy = window.pageYOffset || document.documentElement.scrollTop || 0;
  const cx = cxPage - sx;
  const cy = cyPage - sy;

  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

  // iOS: fewer nodes + shorter radius = much more reliable
  const count = isIOS ? 56 : 180;
  const radiusMin = isIOS ? 30 : 50;
  const radiusMax = isIOS ? 140 : 260;

  viewport.classList.add('shake');
  setTimeout(()=>viewport.classList.remove('shake'), 380);

  const layer = document.getElementById('fxLayer') || document.body;
  const frag = document.createDocumentFragment();

  for(let n=0;n<count;n++){
    const a = Math.random() * Math.PI * 2;
    const len = radiusMin + Math.pow(Math.random(), .6) * (radiusMax - radiusMin);
    const dx = Math.cos(a) * len;
    const dy = Math.sin(a) * len;

    const tw = document.createElement('i');
    tw.className = 'fairy';

    // alternate primary/accent for a two-tone explosion
    tw.style.color = (Math.random() < 0.62) ? p : s;

    tw.style.left = cx + 'px';
    tw.style.top  = cy + 'px';

    tw.style.setProperty('--dx', dx + 'px');
    tw.style.setProperty('--dy', dy + 'px');

    const dur = isIOS ? (1400 + Math.random()*700) : (2100 + Math.random()*1200);
    tw.style.setProperty('--dur', dur + 'ms');
    tw.style.animationDelay = (Math.random()*90) + 'ms';

    frag.appendChild(tw);
    setTimeout(()=>tw.remove(), dur + 700);
  }

  layer.appendChild(frag);
}

/* --------------------------------------
   Style Stop States (two-tone + dim past)
-------------------------------------- */
function styleLive(el,i){
  const p = monthPrimary(i);
  const s = monthAccent(i);

  el.classList.remove('hidden','old');
  el.classList.add('active');

  el.style.opacity = 1;
  el.style.pointerEvents = 'auto';

  el.style.background =
    `radial-gradient(circle,
      ${s} 0%,
      ${p} 42%,
      ${p} 62%,
      #0000 100%)`;

  el.style.boxShadow =
    `0 0 0 2px #0008 inset,
     0 0 16px ${p},
     0 0 34px ${p},
     0 0 12px ${s},
     0 0 26px ${s}`;
}

function stylePast(el,i){
  const p = monthPrimary(i);
  const s = monthAccent(i);

  el.classList.remove('hidden','active');
  el.classList.add('old');

  el.style.opacity = 0.45;
  el.style.pointerEvents = 'auto';

  el.style.background =
    `radial-gradient(circle,
      ${s}22 0%,
      ${p}33 55%,
      #0000 100%)`;

  el.style.boxShadow =
    `0 0 0 1px #ffffff10,
     0 0 8px ${p}55,
     0 0 18px ${p}44,
     0 0 6px ${s}44`;
}

/* ‚úÖ FIXED: removed monthColor() usage entirely */
function applyStopStates(){
  stops.forEach(({el,i})=>{
    const state=getStopState(i);
    el.classList.remove('hidden','active','old');

    if(state==='future'){
      el.classList.add('hidden');
      el.style.opacity=0;
      el.style.pointerEvents='none';
      el.style.background='transparent';
      el.style.boxShadow='none';
    }else if(state==='past'){
      stylePast(el,i);
    }else{
      styleLive(el,i);
    }
  });
}

/* --------------------------------------
   Move Booha
-------------------------------------- */
let currentIndex=-1;
let moving=false;

function moveBoohaToXY(ex,ey){
  return new Promise(resolve=>{
    moving=true;
    const rect=maze.getBoundingClientRect();

    const sx=parseFloat(booha.style.left) || (rect.left+window.scrollX);
    const sy=parseFloat(booha.style.top) || (rect.top+window.scrollY);

    const dx=ex-sx, dy=ey-sy;
    const dist=Math.hypot(dx,dy);
    const dur=Math.max(5200,Math.min(14000,dist*6.5));

    const t0=performance.now();

    function step(t){
      const k=Math.min(1,(t-t0)/dur);
      const e=easeInOutCubic(k);
      const x=sx+dx*e, y=sy+dy*e;
      placeBoohaXY(x,y);

      for(let n=0;n<2;n++){
        if(Math.random()<.9) spawnSpark(x+(Math.random()*4-2),y+(Math.random()*4-2));
      }

      if(k<1) requestAnimationFrame(step);
      else{
        placeBoohaXY(ex,ey);
        moving=false;
        resolve();
      }
    }
    requestAnimationFrame(step);
  });
}

function moveBooha(i){
  const rect=maze.getBoundingClientRect();
  const {x,y}=stopPx(i,rect);
  return moveBoohaToXY(x,y);
}

/* --------------------------------------
   Checkpoint Arrival
-------------------------------------- */
async function playCheckpoint(){
  try{
    sfxCheckpoint.currentTime=0;
    await sfxCheckpoint.play();
  }catch(e){}
  await new Promise(r=>setTimeout(r,4000));
}

/* ‚úÖ FIXED: removed monthColor(); sets glow + glow2 properly */
function setWindowTitles(i){
  const m=Math.floor(i/4);
  const w=(i%4)+1;

  titleEN.textContent=`${MONTHS_EN[m]} ‚Äî Week ${w}`;
  titleJP.textContent=`${MONTHS_JP[m]}„ÄÄÁ¨¨${w}ÈÄ±`;

  const p = monthPrimary(i);
  const s = monthAccent(i);
  card.style.setProperty('--glow', p);
  card.style.setProperty('--glow2', s);
}

function openWindow(){
  modal.classList.add('show');
  card.style.animation='none';
  void card.offsetWidth;
  card.style.animation=null;
}

function closeWindow(){ modal.classList.remove('show'); }

async function arriveAt(i){
  currentStopForModal = i;
  const isNew = !visited[i];

  if(isNew){
    await playCheckpoint();
    fairyBurst(i);
    visited[i]=true;
    if(!bryanMode) saveVisited();
    setTimeout(()=>{ setWindowTitles(i); openWindow(); },2000);
  } else {
    setWindowTitles(i);
    openWindow();
  }
}

/* --------------------------------------
   Clicking a Stop
-------------------------------------- */
async function onStopClick(i){
  if(!gameStarted) return;
  if(moving) return;
  closeWindow();

  const rect=maze.getBoundingClientRect();
  const {x,y}=stopPx(i,rect);

  if(currentIndex!==i){
    await moveBoohaToXY(x,y);
    currentIndex=i;
  }

  await arriveAt(i);
}

/* --------------------------------------
   Next (if you want to hook one later)
-------------------------------------- */
async function goNext(){
  if(!gameStarted || moving) return;
  closeWindow();

  let next;
  if(currentIndex<WINDOW_START || currentIndex>WINDOW_END){
    next=WINDOW_START;
  }else{
    next=currentIndex+1;
    if(next>WINDOW_END) next=WINDOW_START;
  }

  await moveBooha(next);
  currentIndex=next;
  await arriveAt(currentIndex);
}

/* --------------------------------------
   Starting Poof
-------------------------------------- */
function poofAtStart(){
  const pos=startPosition();
  const smoke=document.createElement('div');
  smoke.className='smoke';
  smoke.style.left=pos.x+'px';
  smoke.style.top=pos.y+'px';
  document.body.appendChild(smoke);

  setTimeout(()=>smoke.remove(),1200);

  booha.style.left=pos.x+'px';
  booha.style.top=pos.y+'px';
  booha.style.animation='glowPulse 2s ease-out';

  setTimeout(()=>{
    booha.style.opacity=1;
    booha.classList.add('bobbing');
  },400);
}

/* --------------------------------------
   Resize ‚Äî Keep Booha at Checkpoint
-------------------------------------- */
function realignBoohaToCurrent(){
  if(currentIndex<0) return;
  const rect=maze.getBoundingClientRect();
  const {x,y}=stopPx(currentIndex,rect);
  placeBoohaXY(x,y);
}

/* --------------------------------------
   Close Modal
-------------------------------------- */
closeModalBtn.onclick=(e)=>{
  e.stopPropagation();
  closeWindow();
};

/* --------------------------------------
   BRYAN MODE ‚Äî Enter
-------------------------------------- */
bryanBtn.onclick=()=>{
  const pwd = prompt("Enter BRYAN password");
  if(pwd===null) return;

  if(pwd==="him141amra803"){
    bryanMode=true;
    exitBryanBtn.style.display="inline-block";

    visitedBackup = [...visited];                 // backup
    visited = new Array(POS.length).fill(false);  // reset for re-explosions

    applyStopStates();
    alert("BRYAN MODE ACTIVATED.\nCoordinates ON.");
    enableCoordinates();
  } else {
    alert("Incorrect password.");
  }
};

/* --------------------------------------
   BRYAN MODE ‚Äî EXIT
-------------------------------------- */
exitBryanBtn.onclick=()=>{
  bryanMode=false;
  exitBryanBtn.style.display="none";

  if(visitedBackup) visited = [...visitedBackup];
  saveVisited();
  disableCoordinates();
  applyStopStates();
  alert("Exited Bryan Mode.");
};

/* --------------------------------------
   START GAME BUTTON
-------------------------------------- */
startBtn.onclick=()=>{
  if(gameStarted) return;
  gameStarted=true;

  primeAudio();
  primeSfx();      // ‚úÖ iOS: unlock checkpoint.mp3 on Start tap

  closeWindow();
  poofAtStart();

  if(todayIndex<0 || todayIndex>=POS.length) return;

  const rect=maze.getBoundingClientRect();
  const {x,y}=stopPx(todayIndex,rect);

  setTimeout(async ()=>{
    await moveBoohaToXY(x,y);
    currentIndex=todayIndex;
    await arriveAt(currentIndex);
  },1300);
};

/* --------------------------------------
   MAP OBJECTS ‚Äî SPAWNER (one-time engine hook)
-------------------------------------- */
function spawnMapObjects(){
  if(!maze || !Array.isArray(MAP_OBJECTS)) return;

  const token = getToken(); // uses your existing helper

  MAP_OBJECTS.forEach(obj=>{
    if(!obj || !obj.img || typeof obj.x!=="number" || typeof obj.y!=="number") return;

    const el = document.createElement("img");
    el.className = "mapObj glow";
    el.id = obj.id || ("mapobj-" + Math.random().toString(16).slice(2));
    el.src = obj.img;
    el.alt = obj.id || "map object";

    el.style.left = obj.x + "%";
    el.style.top  = obj.y + "%";
    el.style.width = (obj.wPct || 14) + "%";
    el.style.height = "auto";

    el.addEventListener("click", (e)=>{
      e.stopPropagation();
      if(!obj.href){
        alert("Link not set yet!");
        return;
      }
      const target = withToken(obj.href, token); // uses your existing helper
      if(obj.open === "new-tab") window.open(target, "_blank");
      else window.location.href = target;
    });

    maze.appendChild(el);
  });
}

/* --------------------------------------
   Initial Setup
-------------------------------------- */
window.onload=()=>{
  const pos=startPosition();
  placeBoohaXY(pos.x,pos.y);

  todayIndex=getCurrentIndexFromDate();
  updateWindowFromCurrentIndex(todayIndex);
  applyStopStates();

  spawnMapObjects(); // ‚úÖ add this line

// BooTree glow + link
if(booTree){
  setTimeout(()=>{
    booTree.classList.add('glow');

    const tetrisTree = document.getElementById("tetrisTree");
    if(tetrisTree) tetrisTree.classList.add("glow");

  },1500);

  booTree.addEventListener('click',()=>{
    window.open(
      "https://booha-adventure-studios.github.io/Boo-Riculum-2026/",
      "_blank"
    );
  });
}

/* Tetris Tree click ‚Üí Booha Blocks */
const tetrisTree = document.getElementById("tetrisTree");
if(tetrisTree){
  tetrisTree.addEventListener('click',()=>{
    window.open(
      "https://booha-adventure-studios.github.io/booha-blocks/",
      "_blank"
    );
  });
}



window.addEventListener('resize',()=>{
  requestAnimationFrame(realignBoohaToCurrent);
});

/* --------------------------------------
   DECK BUTTON CLICK HANDLERS (uses DECK_LINKS + token carry-over)
-------------------------------------- */
function getToken(){
  const params = new URLSearchParams(window.location.search);
  return params.get("token") || sessionStorage.getItem("boohaToken") || "";
}

function withToken(url, token){
  if(!url) return "";
  if(!token) return url;
  return url + (url.includes("?") ? "&" : "?") + "token=" + encodeURIComponent(token);
}

function goToDeck(which){
  const row = DECK_LINKS[currentStopForModal];
  const baseUrl = row ? row[which] : "";
  if(!baseUrl){
    alert("Link not set for this checkpoint yet!");
    return;
  }
  const token = getToken();
  window.location.href = withToken(baseUrl, token);
}

document.getElementById("deck-study").onclick = ()=> goToDeck("study");
document.getElementById("deck-games").onclick = ()=> goToDeck("games");

/* --------------------------------------
   BRYAN MODE ‚Äî COORDINATE TOOL
-------------------------------------- */
let coordPanel=null;
let coordToggleBtn=null;
let coordMarkers=[];

function enableCoordinates(){
  if(!coordPanel){
    coordPanel=document.createElement("div");
    coordPanel.style.position="fixed";
    coordPanel.style.bottom="80px";
    coordPanel.style.right="12px";
    coordPanel.style.background="#0b1c11cc";
    coordPanel.style.color="#fff";
    coordPanel.style.padding="10px 14px";
    coordPanel.style.border="1px solid #ffffff33";
    coordPanel.style.borderRadius="8px";
    coordPanel.style.fontFamily="monospace";
    coordPanel.style.zIndex="9999";
    coordPanel.textContent="Tap the maze";
    document.body.appendChild(coordPanel);
  }

  if(!coordToggleBtn){
    coordToggleBtn=document.createElement("button");
    coordToggleBtn.textContent="Hide Coordinates";
    coordToggleBtn.style.position="fixed";
    coordToggleBtn.style.bottom="12px";
    coordToggleBtn.style.right="12px";
    coordToggleBtn.style.zIndex="9999";
    coordToggleBtn.style.padding="8px 12px";
    coordToggleBtn.style.fontWeight="700";
    coordToggleBtn.style.borderRadius="8px";
    coordToggleBtn.style.border="1px solid #ffffff33";
    coordToggleBtn.style.background="#203a27";
    coordToggleBtn.style.color="#fff";
    coordToggleBtn.style.cursor="pointer";
    coordToggleBtn.onclick=toggleCoordinates;
    document.body.appendChild(coordToggleBtn);
  }

  maze.addEventListener("click", coordClick);
  coordPanel.style.display="block";
  coordToggleBtn.style.display="block";
}

function disableCoordinates(){
  maze.removeEventListener("click", coordClick);
  if(coordPanel) coordPanel.style.display="none";
  if(coordToggleBtn) coordToggleBtn.style.display="none";

  coordMarkers.forEach(m=>m.remove());
  coordMarkers=[];
}

let coordsHidden=false;
function toggleCoordinates(){
  coordsHidden=!coordsHidden;
  coordPanel.style.display = coordsHidden ? "none" : "block";
  coordMarkers.forEach(m=>m.style.display = coordsHidden ? "none" : "block");
  coordToggleBtn.textContent = coordsHidden ? "Show Coordinates" : "Hide Coordinates";
}

function coordClick(e){
  const rect=maze.getBoundingClientRect();
  const px = ((e.clientX - rect.left) / rect.width) * 100;
  const py = ((e.clientY - rect.top) / rect.height) * 100;

  coordPanel.textContent = `X: ${px.toFixed(2)}%, Y: ${py.toFixed(2)}%`;

  const marker=document.createElement("div");
  marker.style.position="absolute";
  marker.style.left=e.pageX+"px";
  marker.style.top=e.pageY+"px";
  marker.style.width="10px";
  marker.style.height="10px";
  marker.style.background="#00ff00";
  marker.style.borderRadius="50%";
  marker.style.border="2px solid #fff";
  marker.style.zIndex="9998";
  marker.style.pointerEvents="none";

  document.body.appendChild(marker);
  coordMarkers.push(marker);
}
</script>

<!-- FX layer for explosions / sparkles -->
<div id="fxLayer" aria-hidden="true"></div>

</body>
</html>
